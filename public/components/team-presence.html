<!-- Team Presence Widget - Include this on all admin pages -->
<style>
  .team-presence-widget {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    padding: 1rem;
    min-width: 250px;
    max-width: 300px;
    z-index: 999;
  }
  .team-presence-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e5e7eb;
  }
  .team-presence-header h4 {
    font-size: 0.875rem;
    font-weight: 600;
    color: #111827;
    margin: 0;
  }
  .team-presence-toggle {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.25rem;
    padding: 0;
  }
  .team-presence-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  .team-presence-list.collapsed {
    display: none;
  }
  .team-member-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    border-radius: 6px;
    background: #f9fafb;
  }
  .presence-indicator {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .presence-online {
    background: #10b981;
    box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
  }
  .presence-away {
    background: #f59e0b;
    box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2);
  }
  .presence-offline {
    background: #6b7280;
  }
  .team-member-info {
    flex: 1;
    min-width: 0;
  }
  .team-member-name {
    font-size: 0.875rem;
    font-weight: 500;
    color: #111827;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .team-member-status {
    font-size: 0.75rem;
    color: #6b7280;
  }
  .you-badge {
    font-size: 0.625rem;
    background: #dbeafe;
    color: #1e40af;
    padding: 0.125rem 0.375rem;
    border-radius: 4px;
    font-weight: 600;
  }
</style>

<div class="team-presence-widget" id="teamPresenceWidget">
  <div class="team-presence-header">
    <h4>ðŸ‘¥ Team</h4>
    <button class="team-presence-toggle" onclick="toggleTeamPresence()">âˆ’</button>
  </div>
  <div class="team-presence-list" id="teamPresenceList">
    <div style="text-align: center; color: #6b7280; font-size: 0.875rem;">Loading...</div>
  </div>
</div>

<script>
  let teamPresenceCollapsed = false;
  let teamPresenceInterval = null;

  function toggleTeamPresence() {
    teamPresenceCollapsed = !teamPresenceCollapsed;
    const list = document.getElementById('teamPresenceList');
    const button = document.querySelector('.team-presence-toggle');
    
    if (teamPresenceCollapsed) {
      list.classList.add('collapsed');
      button.textContent = '+';
    } else {
      list.classList.remove('collapsed');
      button.textContent = 'âˆ’';
    }
  }

  async function loadTeamPresence() {
    try {
      const response = await fetch(`${window.location.origin}/api/users`, {
        credentials: 'include'
      });
      
      if (!response.ok) return;
      
      const users = await response.json();
      const container = document.getElementById('teamPresenceList');
      
      if (users.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #6b7280; font-size: 0.875rem;">No team members</div>';
        return;
      }

      // Get current user from global scope if available
      const currentUserId = window.currentUser?.id;
      
      container.innerHTML = users.map(user => {
        const isCurrentUser = currentUserId === user.id;
        const lastSeen = user.last_seen ? new Date(user.last_seen) : null;
        const now = new Date();
        const minutesAgo = lastSeen ? Math.floor((now - lastSeen) / 1000 / 60) : null;
        
        let presenceClass = 'presence-offline';
        let statusText = 'Offline';
        
        if (user.is_muted) {
          presenceClass = 'presence-away';
          statusText = 'Muted';
        } else if (minutesAgo !== null) {
          if (minutesAgo < 5) {
            presenceClass = 'presence-online';
            statusText = 'Active now';
          } else if (minutesAgo < 30) {
            presenceClass = 'presence-away';
            statusText = `${minutesAgo}m ago`;
          } else if (minutesAgo < 1440) {
            const hoursAgo = Math.floor(minutesAgo / 60);
            presenceClass = 'presence-offline';
            statusText = `${hoursAgo}h ago`;
          } else {
            presenceClass = 'presence-offline';
            statusText = 'Offline';
          }
        }
        
        return `
          <div class="team-member-item">
            <div class="presence-indicator ${presenceClass}"></div>
            <div class="team-member-info">
              <div class="team-member-name">
                ${user.name}
                ${isCurrentUser ? '<span class="you-badge">YOU</span>' : ''}
              </div>
              <div class="team-member-status">${statusText}</div>
            </div>
          </div>
        `;
      }).join('');
    } catch (error) {
      console.error('Failed to load team presence:', error);
    }
  }

  // Update presence every 30 seconds
  function startTeamPresenceUpdates() {
    loadTeamPresence();
    if (teamPresenceInterval) clearInterval(teamPresenceInterval);
    teamPresenceInterval = setInterval(loadTeamPresence, 30000);
  }

  // Update own last_seen every 60 seconds
  async function updateOwnPresence() {
    try {
      const response = await fetch(`${window.location.origin}/api/auth/me`, {
        credentials: 'include'
      });
      
      if (response.ok) {
        const user = await response.json();
        if (user.id) {
          await fetch(`${window.location.origin}/api/users/${user.id}/presence`, {
            method: 'POST',
            credentials: 'include'
          });
        }
      }
    } catch (error) {
      // Silently fail
    }
  }

  // Start presence tracking
  if (typeof window.currentUser !== 'undefined') {
    startTeamPresenceUpdates();
    updateOwnPresence();
    setInterval(updateOwnPresence, 60000);
  }
</script>
