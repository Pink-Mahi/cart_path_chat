<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Cart Path Cleaning</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f3f4f6;
      color: #111827;
      height: 100vh;
      overflow: hidden;
    }

    /* Main Layout */
    .dashboard-container {
      display: grid;
      grid-template-columns: 280px 1fr 320px;
      grid-template-rows: 60px 1fr;
      height: 100vh;
    }

    /* Header */
    .dashboard-header {
      grid-column: 1 / -1;
      background: #10b981;
      color: white;
      padding: 0 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .header-title {
      font-size: 1.25rem;
      font-weight: 600;
    }
    .header-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    .header-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      transition: background 0.2s;
    }
    .header-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    /* Left Sidebar - Team */
    .team-sidebar {
      background: #1f2937;
      color: white;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .team-header {
      padding: 1rem;
      border-bottom: 1px solid #374151;
      font-weight: 600;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #9ca3af;
    }
    .team-list {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
    }
    .team-member {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
      margin-bottom: 0.25rem;
    }
    .team-member:hover {
      background: #374151;
    }
    .presence-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .presence-online { background: #10b981; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3); }
    .presence-away { background: #f59e0b; box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.3); }
    .presence-offline { background: #6b7280; }
    .team-member-info {
      flex: 1;
      min-width: 0;
    }
    .team-member-name {
      font-size: 0.875rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .team-member-status {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    /* Main Content Area */
    .main-content {
      background: white;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .content-tabs {
      display: flex;
      border-bottom: 1px solid #e5e7eb;
      padding: 0 1rem;
      background: #f9fafb;
    }
    .tab {
      padding: 1rem 1.5rem;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      color: #6b7280;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    .tab:hover {
      color: #111827;
    }
    .tab.active {
      color: #10b981;
      border-bottom-color: #10b981;
    }
    .content-body {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }

    /* Conversations List */
    .conversation-card {
      background: #f9fafb;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid #e5e7eb;
    }
    .conversation-card:hover {
      background: #f3f4f6;
      border-color: #10b981;
    }
    .conversation-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 0.5rem;
    }
    .visitor-name {
      font-weight: 600;
      font-size: 1rem;
    }
    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .status-unassigned { background: #fee2e2; color: #991b1b; }
    .status-assigned { background: #dbeafe; color: #1e40af; }
    .status-resolved { background: #d1fae5; color: #065f46; }
    .status-needs_human { background: #fef3c7; color: #92400e; }
    .last-message {
      color: #6b7280;
      font-size: 0.875rem;
      margin-bottom: 0.5rem;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .conversation-meta {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: #9ca3af;
    }
    .assigned-to {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 0.25rem;
    }

    /* Right Sidebar - Team Chat */
    .team-chat-sidebar {
      background: white;
      border-left: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .chat-header {
      padding: 1rem;
      border-bottom: 1px solid #e5e7eb;
      font-weight: 600;
      background: #f9fafb;
    }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .chat-message {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .chat-message-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .chat-sender {
      font-weight: 600;
      font-size: 0.875rem;
    }
    .chat-time {
      font-size: 0.75rem;
      color: #9ca3af;
    }
    .chat-content {
      background: #f3f4f6;
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
      font-size: 0.875rem;
      line-height: 1.5;
    }
    .chat-input-container {
      padding: 1rem;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 0.5rem;
    }
    .chat-input {
      flex: 1;
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 0.875rem;
    }
    .send-btn {
      padding: 0.75rem 1.5rem;
      background: #10b981;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s;
    }
    .send-btn:hover {
      background: #059669;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }
    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: start;
    }
    .modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
    }
    .modal-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 0.5rem;
    }
    .message {
      margin-bottom: 1rem;
      padding: 0.75rem;
      border-radius: 8px;
      max-width: 80%;
    }
    .message-visitor {
      background: #f3f4f6;
      align-self: flex-start;
    }
    .message-admin {
      background: #d1fae5;
      align-self: flex-end;
      margin-left: auto;
    }
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }
    .btn-primary {
      background: #10b981;
      color: white;
    }
    .btn-primary:hover {
      background: #059669;
    }
    .btn-secondary {
      background: #6b7280;
      color: white;
    }
    .btn-secondary:hover {
      background: #4b5563;
    }
  </style>
</head>
<body>
  <!-- Dashboard Header -->
  <div class="dashboard-container">
    <div class="dashboard-header">
      <div class="header-title">üí¨ Cart Path Cleaning - Admin Dashboard</div>
      <div class="header-actions">
        <button class="header-btn" onclick="window.location.href='/knowledge-base.html'" id="knowledgeBaseBtn" style="display: none;">ü§ñ AI Knowledge</button>
        <button class="header-btn" onclick="window.location.href='/canned-responses.html'">üí¨ Quick Replies</button>
        <button class="header-btn" onclick="window.location.href='/my-settings.html'">‚öôÔ∏è Settings</button>
        <button class="header-btn" onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- Left Sidebar - Team -->
    <div class="team-sidebar">
      <div class="team-header" onclick="window.location.href='/team.html'" style="cursor: pointer;">üë• Team Members</div>
      <div class="team-list" id="teamList">
        <div style="text-align: center; color: #9ca3af; padding: 1rem; font-size: 0.875rem;">Loading...</div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="content-tabs">
        <button class="tab active" onclick="switchTab('conversations')">üí¨ Conversations</button>
        <button class="tab" onclick="switchTab('visits')">üìÖ Scheduled Visits</button>
        <button class="tab" onclick="switchTab('calls')">üìû Call Requests</button>
      </div>
      <div class="content-body" id="contentBody">
        <!-- Dynamic content loaded here -->
      </div>
    </div>

    <!-- Right Sidebar - Team Chat -->
    <div class="team-chat-sidebar">
      <div class="chat-header">üí¨ Team Chat</div>
      <div class="chat-messages" id="teamChatMessages">
        <div style="text-align: center; color: #9ca3af; padding: 2rem; font-size: 0.875rem;">
          Internal team chat for coordination<br><small>Messages here are private to your team</small>
        </div>
      </div>
      <div class="chat-input-container">
        <input type="text" id="teamChatInput" class="chat-input" placeholder="Message your team..." />
        <button class="send-btn" onclick="sendTeamMessage()">Send</button>
      </div>
    </div>
  </div>

  <!-- Conversation Modal -->
  <div id="conversationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <div class="visitor-name" id="modalVisitorName"></div>
          <div style="font-size: 0.875rem; color: #6b7280;" id="modalVisitorEmail"></div>
          <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;" id="modalAssignedTo"></div>
        </div>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
          <select id="reassignSelect" onchange="reassignConversation()" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; background: white; cursor: pointer; display: none;">
            <option value="">Reassign to...</option>
          </select>
          <button class="btn btn-primary" onclick="assignToMe()" id="assignBtn" style="display: none;">Assign to Me</button>
          <button class="btn btn-primary" onclick="markResolved()" id="resolveBtn" style="display: none;">Mark Resolved</button>
          <button class="btn btn-secondary" onclick="closeModal()">Close</button>
        </div>
      </div>
      <div class="modal-body" id="modalMessages" style="display: flex; flex-direction: column;"></div>
      <div id="typingIndicator" style="display: none; padding: 0.5rem 1rem; background: #f3f4f6; border-top: 1px solid #e5e7eb; font-size: 0.875rem; color: #6b7280; font-style: italic;">
        <span id="typingText">Visitor is typing...</span>
      </div>
      <div class="modal-footer">
        <select id="quickReplySelect" onchange="insertQuickReply()" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; background: white; cursor: pointer; margin-right: 0.5rem;">
          <option value="">üí¨ Quick Replies</option>
        </select>
        <input type="text" id="replyInput" class="chat-input" placeholder="Type your reply..." style="flex: 1;" />
        <button class="btn btn-primary" onclick="sendReply()">Send</button>
      </div>
    </div>
  </div>

  <!-- Visit Detail Modal -->
  <div id="visitModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <div class="visitor-name" id="visitModalName"></div>
          <div style="font-size: 0.875rem; color: #6b7280;" id="visitModalEmail"></div>
        </div>
        <div style="display: flex; gap: 0.5rem;">
          <button class="btn btn-primary" onclick="confirmVisit()" id="visitConfirmBtn">‚úì Confirm Visit</button>
          <button class="btn btn-secondary" onclick="closeVisitModal()">Close</button>
        </div>
      </div>
      <div class="modal-body" style="padding: 1.5rem;">
        <div style="display: grid; gap: 1rem;">
          <div>
            <strong>üìÖ Date & Time:</strong>
            <div id="visitModalDateTime" style="color: #6b7280; margin-top: 0.25rem;"></div>
          </div>
          <div>
            <strong>üìû Phone:</strong>
            <div id="visitModalPhone" style="color: #6b7280; margin-top: 0.25rem;"></div>
          </div>
          <div>
            <strong>üìç Address:</strong>
            <div id="visitModalAddress" style="color: #6b7280; margin-top: 0.25rem;"></div>
          </div>
          <div>
            <strong>üè† Property Type:</strong>
            <div id="visitModalPropertyType" style="color: #6b7280; margin-top: 0.25rem;"></div>
          </div>
          <div>
            <strong>üìù Additional Details:</strong>
            <div id="visitModalDetails" style="color: #6b7280; margin-top: 0.25rem;"></div>
          </div>
          <div>
            <strong>Status:</strong>
            <span id="visitModalStatus" class="status-badge"></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Call Request Detail Modal -->
  <div id="callModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <div class="visitor-name" id="callModalName"></div>
          <div style="font-size: 0.875rem; color: #6b7280;" id="callModalEmail"></div>
        </div>
        <div style="display: flex; gap: 0.5rem;">
          <button class="btn btn-primary" onclick="markCallComplete()" id="callCompleteBtn">‚úì Mark Complete</button>
          <button class="btn btn-secondary" onclick="closeCallModal()">Close</button>
        </div>
      </div>
      <div class="modal-body" style="padding: 1.5rem;">
        <div style="display: grid; gap: 1rem;">
          <div>
            <strong>üìû Phone Number:</strong>
            <div id="callModalPhone" style="color: #6b7280; margin-top: 0.25rem; font-size: 1.25rem;"></div>
          </div>
          <div>
            <strong>‚è∞ Requested:</strong>
            <div id="callModalTime" style="color: #6b7280; margin-top: 0.25rem;"></div>
          </div>
          <div>
            <strong>Status:</strong>
            <span id="callModalStatus" class="status-badge"></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = window.location.origin;
    let currentUser = null;
    let currentConversationId = null;
    let currentTab = 'conversations';
    let updateInterval = null;
    let conversationPollInterval = null;
    let dashboardWs = null;
    let typingTimeouts = new Map(); // Track typing timeouts per conversation

    async function checkAuth() {
      try {
        const response = await fetch(`${API_URL}/api/auth/status`, { credentials: 'include' });
        const data = await response.json();
        if (!data.authenticated) {
          window.location.href = '/login.html';
          return false;
        }
        currentUser = data.user;
        return true;
      } catch (error) {
        window.location.href = '/login.html';
        return false;
      }
    }

    async function logout() {
      await fetch(`${API_URL}/api/auth/logout`, { method: 'POST', credentials: 'include' });
      window.location.href = '/login.html';
    }

    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      loadContent();
    }

    async function loadContent() {
      const container = document.getElementById('contentBody');
      
      if (currentTab === 'conversations') {
        await loadConversations();
      } else if (currentTab === 'visits') {
        await loadVisits();
      } else if (currentTab === 'calls') {
        await loadCalls();
      }
    }

    async function loadConversations() {
      try {
        const response = await fetch(`${API_URL}/api/conversations`, { credentials: 'include' });
        const conversations = await response.json();
        const container = document.getElementById('contentBody');
        
        if (conversations.length === 0) {
          container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6b7280;">No conversations yet</div>';
          return;
        }

        container.innerHTML = conversations.map(conv => {
          const statusText = conv.status === 'unassigned' ? 'Unassigned' :
                            conv.status === 'assigned' ? 'In Progress' :
                            conv.status === 'resolved' ? 'Resolved' :
                            conv.status === 'needs_human' ? 'Needs Human' : conv.status;
          
          const assignedInfo = conv.assigned_to_name ? 
            `<div class="assigned-to">üë§ ${conv.assigned_to_name}</div>` : '';
          
          return `
            <div class="conversation-card" style="position: relative;">
              <div onclick="openConversation('${conv.id}')" style="cursor: pointer; padding-right: 3rem;">
                <div class="conversation-header">
                  <div>
                    <div class="visitor-name">${conv.visitor_name || 'Anonymous'}</div>
                    ${assignedInfo}
                  </div>
                  <span class="status-badge status-${conv.status}">${statusText}</span>
                </div>
                <div class="last-message">${conv.last_message || 'No messages yet'}</div>
                <div class="conversation-meta">
                  <span>${conv.visitor_email || 'No email'}</span>
                  <span>${conv.message_count} messages</span>
                </div>
              </div>
              <button onclick="event.stopPropagation(); deleteConversation('${conv.id}')" style="position: absolute; bottom: 0.5rem; right: 0.5rem; background: #ef4444; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer; font-size: 0.75rem; opacity: 0.8;" title="Delete conversation">üóëÔ∏è</button>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Failed to load conversations:', error);
      }
    }

    async function loadVisits() {
      try {
        const response = await fetch(`${API_URL}/api/scheduled-visits`, { credentials: 'include' });
        const visits = await response.json();
        const container = document.getElementById('contentBody');
        
        if (visits.length === 0) {
          container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6b7280;">No scheduled visits</div>';
          return;
        }

        container.innerHTML = visits.map(visit => `
          <div class="conversation-card" style="position: relative;">
            <div onclick="openVisitDetail('${visit.id}')" style="cursor: pointer; padding-right: 3rem;">
              <div class="conversation-header">
                <div class="visitor-name">${visit.visitor_name}</div>
                <span class="status-badge status-${visit.status}">${visit.status}</span>
              </div>
              <div class="last-message">üìÖ ${new Date(visit.preferred_date).toLocaleDateString()} at ${visit.preferred_time}</div>
              <div class="conversation-meta">
                <span>${visit.visitor_email}</span>
                <span>${visit.visitor_phone || 'No phone'}</span>
              </div>
            </div>
            <button onclick="event.stopPropagation(); deleteVisit('${visit.id}')" style="position: absolute; bottom: 0.5rem; right: 0.5rem; background: #ef4444; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer; font-size: 0.75rem; opacity: 0.8;" title="Delete visit">üóëÔ∏è</button>
          </div>
        `).join('');
      } catch (error) {
        console.error('Failed to load visits:', error);
      }
    }

    async function loadCalls() {
      try {
        const response = await fetch(`${API_URL}/api/call-requests`, { credentials: 'include' });
        const calls = await response.json();
        const container = document.getElementById('contentBody');
        
        if (calls.length === 0) {
          container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6b7280;">No call requests</div>';
          return;
        }

        container.innerHTML = calls.map(call => `
          <div class="conversation-card" style="position: relative;">
            <div onclick="openCallDetail('${call.id}')" style="cursor: pointer; padding-right: 3rem;">
              <div class="conversation-header">
                <div class="visitor-name">${call.visitor_name}</div>
                <span class="status-badge status-${call.status}">${call.status}</span>
              </div>
              <div class="last-message">üìû ${call.visitor_phone}</div>
              <div class="conversation-meta">
                <span>${call.visitor_email || 'No email'}</span>
                <span>${new Date(call.created_at).toLocaleString()}</span>
              </div>
            </div>
            <button onclick="event.stopPropagation(); deleteCallRequest('${call.id}')" style="position: absolute; bottom: 0.5rem; right: 0.5rem; background: #ef4444; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer; font-size: 0.75rem; opacity: 0.8;" title="Delete call request">üóëÔ∏è</button>
          </div>
        `).join('');
      } catch (error) {
        console.error('Failed to load calls:', error);
      }
    }

    async function loadTeam() {
      try {
        const response = await fetch(`${API_URL}/api/users`, { credentials: 'include' });
        
        if (!response.ok) {
          throw new Error('Failed to fetch team members');
        }
        
        const users = await response.json();
        const container = document.getElementById('teamList');
        
        if (!users || users.length === 0) {
          container.innerHTML = '<div style="text-align: center; color: #9ca3af; padding: 1rem; font-size: 0.875rem;">No team members</div>';
          return;
        }
        
        // Ensure currentUser is available before mapping
        if (!currentUser) {
          console.warn('currentUser not yet loaded, skipping team render');
          return;
        }
        
        container.innerHTML = users.map(user => {
          const isCurrentUser = currentUser.id === user.id;
          const lastSeen = user.last_seen ? new Date(user.last_seen) : null;
          const now = new Date();
          const minutesAgo = lastSeen ? Math.floor((now - lastSeen) / 1000 / 60) : null;
          
          let presenceClass = 'presence-offline';
          let statusText = 'Offline';
          
          if (user.is_muted) {
            presenceClass = 'presence-away';
            statusText = 'Muted';
          } else if (minutesAgo !== null) {
            if (minutesAgo < 5) {
              presenceClass = 'presence-online';
              statusText = 'Active now';
            } else if (minutesAgo < 30) {
              presenceClass = 'presence-away';
              statusText = `${minutesAgo}m ago`;
            } else {
              presenceClass = 'presence-offline';
              statusText = 'Offline';
            }
          }
          
          return `
            <div class="team-member">
              <div class="presence-dot ${presenceClass}"></div>
              <div class="team-member-info">
                <div class="team-member-name">${user.name}${isCurrentUser ? ' (You)' : ''}</div>
                <div class="team-member-status">${statusText}</div>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Failed to load team:', error);
        const container = document.getElementById('teamList');
        container.innerHTML = '<div style="text-align: center; color: #ef4444; padding: 1rem; font-size: 0.875rem;">Failed to load team members</div>';
      }
    }

    async function loadTeamChat() {
      try {
        const response = await fetch(`${API_URL}/api/team-chat`, { credentials: 'include' });
        const messages = await response.json();
        const container = document.getElementById('teamChatMessages');
        
        if (messages.length === 0) {
          container.innerHTML = '<div style="text-align: center; color: #9ca3af; padding: 2rem; font-size: 0.875rem;">No messages yet<br><small>Start chatting with your team!</small></div>';
          return;
        }

        container.innerHTML = messages.map(msg => {
          const isOwnMessage = currentUser && msg.sender_id === currentUser.id;
          const editedLabel = msg.updated_at ? ' <small style="color: #9ca3af;">(edited)</small>' : '';
          
          return `
            <div class="chat-message" id="msg-${msg.id}">
              <div class="chat-message-header">
                <span class="chat-sender">${msg.sender_name}${editedLabel}</span>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                  <span class="chat-time">${new Date(msg.created_at).toLocaleTimeString()}</span>
                  ${isOwnMessage ? `
                    <button onclick="editTeamMessage('${msg.id}', '${msg.content.replace(/'/g, "\\'")}', event)" style="background: none; border: none; cursor: pointer; color: #6b7280; padding: 0.25rem; font-size: 0.75rem;" title="Edit">‚úèÔ∏è</button>
                    <button onclick="deleteTeamMessage('${msg.id}', event)" style="background: none; border: none; cursor: pointer; color: #ef4444; padding: 0.25rem; font-size: 0.75rem;" title="Delete">üóëÔ∏è</button>
                  ` : ''}
                </div>
              </div>
              <div class="chat-content" id="content-${msg.id}">${msg.content}</div>
              <div id="edit-${msg.id}" style="display: none; margin-top: 0.5rem;" onclick="event.stopPropagation()">
                <input type="text" id="input-${msg.id}" value="${msg.content.replace(/"/g, '&quot;')}" onkeypress="if(event.key==='Enter') saveTeamMessageEdit('${msg.id}')" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;" />
                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                  <button onclick="event.stopPropagation(); saveTeamMessageEdit('${msg.id}')" style="padding: 0.25rem 0.75rem; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">Save</button>
                  <button onclick="event.stopPropagation(); cancelTeamMessageEdit('${msg.id}')" style="padding: 0.25rem 0.75rem; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">Cancel</button>
                </div>
              </div>
            </div>
          `;
        }).join('');
        
        container.scrollTop = container.scrollHeight;
      } catch (error) {
        console.error('Failed to load team chat:', error);
      }
    }

    async function sendTeamMessage() {
      const input = document.getElementById('teamChatInput');
      const content = input.value.trim();
      if (!content) return;

      try {
        const response = await fetch(`${API_URL}/api/team-chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ content })
        });
        
        if (!response.ok) {
          const error = await response.json();
          console.error('Failed to send message:', error);
          alert('Failed to send message: ' + (error.error || 'Unknown error'));
          return;
        }
        
        input.value = '';
        setTimeout(() => loadTeamChat(), 100);
      } catch (error) {
        console.error('Failed to send message:', error);
        alert('Failed to send message. Please try again.');
      }
    }

    function editTeamMessage(id, content, event) {
      event.stopPropagation();
      document.getElementById(`content-${id}`).style.display = 'none';
      document.getElementById(`edit-${id}`).style.display = 'block';
      document.getElementById(`input-${id}`).focus();
    }

    function cancelTeamMessageEdit(id) {
      document.getElementById(`content-${id}`).style.display = 'block';
      document.getElementById(`edit-${id}`).style.display = 'none';
    }

    async function saveTeamMessageEdit(id) {
      const input = document.getElementById(`input-${id}`);
      const content = input.value.trim();
      
      if (!content) {
        alert('Message cannot be empty');
        input.focus();
        return;
      }

      try {
        const response = await fetch(`${API_URL}/api/team-chat/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ content })
        });
        
        if (!response.ok) {
          const error = await response.json();
          console.error('Edit failed:', error);
          alert('Failed to edit message: ' + (error.error || 'Unknown error'));
          input.focus();
          return;
        }
        
        // Successfully saved, reload chat
        await loadTeamChat();
      } catch (error) {
        console.error('Failed to edit message:', error);
        alert('Failed to edit message. Please try again.');
        input.focus();
      }
    }

    async function deleteTeamMessage(id, event) {
      event.stopPropagation();
      
      if (!confirm('Are you sure you want to delete this message?')) {
        return;
      }

      try {
        const response = await fetch(`${API_URL}/api/team-chat/${id}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (!response.ok) {
          const error = await response.json();
          alert('Failed to delete message: ' + (error.error || 'Unknown error'));
          return;
        }
        
        loadTeamChat();
      } catch (error) {
        console.error('Failed to delete message:', error);
        alert('Failed to delete message. Please try again.');
      }
    }

    async function refreshConversationMessages() {
      if (!currentConversationId) return;
      
      try {
        const response = await fetch(`${API_URL}/api/conversations/${currentConversationId}`, { credentials: 'include' });
        const data = await response.json();
        
        const messagesContainer = document.getElementById('modalMessages');
        const currentScroll = messagesContainer.scrollTop;
        const isScrolledToBottom = messagesContainer.scrollHeight - messagesContainer.scrollTop <= messagesContainer.clientHeight + 50;
        
        messagesContainer.innerHTML = data.messages.map(msg => `
          <div class="message message-${msg.sender}">${msg.content}</div>
        `).join('');
        
        // Auto-scroll to bottom if user was already at bottom
        if (isScrolledToBottom) {
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        } else {
          messagesContainer.scrollTop = currentScroll;
        }
      } catch (error) {
        console.error('Failed to refresh messages:', error);
      }
    }

    async function openConversation(id) {
      currentConversationId = id;
      
      // Clear any existing poll interval
      if (conversationPollInterval) {
        clearInterval(conversationPollInterval);
      }
      
      try {
        const response = await fetch(`${API_URL}/api/conversations/${id}`, { credentials: 'include' });
        const data = await response.json();
        
        document.getElementById('modalVisitorName').textContent = data.conversation.visitor_name || 'Anonymous';
        document.getElementById('modalVisitorEmail').textContent = data.conversation.visitor_email || 'No email';
        
        const assignedToEl = document.getElementById('modalAssignedTo');
        const assignBtn = document.getElementById('assignBtn');
        const resolveBtn = document.getElementById('resolveBtn');
        const reassignSelect = document.getElementById('reassignSelect');
        
        if (data.conversation.assigned_to) {
          assignedToEl.textContent = `üë§ Assigned to: ${data.conversation.assigned_to_name || 'Unknown'}`;
          assignBtn.style.display = 'none';
          resolveBtn.style.display = data.conversation.status !== 'resolved' ? 'inline-block' : 'none';
          // Show reassign dropdown for both admins and agents
          reassignSelect.style.display = 'inline-block';
        } else {
          assignedToEl.textContent = '‚ö†Ô∏è Unassigned';
          assignBtn.style.display = 'inline-block';
          resolveBtn.style.display = 'none';
          // Allow agents to reassign unassigned conversations too
          reassignSelect.style.display = 'inline-block';
        }
        
        const messagesContainer = document.getElementById('modalMessages');
        messagesContainer.innerHTML = data.messages.map(msg => `
          <div class="message message-${msg.sender}">${msg.content}</div>
        `).join('');
        
        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Load quick replies and team members for reassignment
        loadQuickReplies();
        loadTeamMembersForReassign();
        
        document.getElementById('conversationModal').classList.add('active');
        
        // Start polling for new messages every 3 seconds
        conversationPollInterval = setInterval(refreshConversationMessages, 3000);
      } catch (error) {
        console.error('Failed to load conversation:', error);
      }
    }

    function closeModal() {
      // Stop polling when modal closes
      if (conversationPollInterval) {
        clearInterval(conversationPollInterval);
        conversationPollInterval = null;
      }
      
      document.getElementById('conversationModal').classList.remove('active');
      currentConversationId = null;
      loadContent();
    }

    let currentVisitId = null;
    let currentCallId = null;

    async function openVisitDetail(id) {
      currentVisitId = id;
      try {
        const response = await fetch(`${API_URL}/api/scheduled-visits/${id}`, { credentials: 'include' });
        const visit = await response.json();
        
        document.getElementById('visitModalName').textContent = visit.visitor_name;
        document.getElementById('visitModalEmail').textContent = visit.visitor_email;
        document.getElementById('visitModalDateTime').textContent = `${new Date(visit.preferred_date).toLocaleDateString()} at ${visit.preferred_time}`;
        document.getElementById('visitModalPhone').textContent = visit.visitor_phone || 'No phone provided';
        document.getElementById('visitModalAddress').textContent = visit.property_address || 'No address provided';
        document.getElementById('visitModalPropertyType').textContent = visit.property_type || 'Not specified';
        document.getElementById('visitModalDetails').textContent = visit.notes || 'No additional details';
        
        const statusBadge = document.getElementById('visitModalStatus');
        statusBadge.textContent = visit.status;
        statusBadge.className = `status-badge status-${visit.status}`;
        
        const confirmBtn = document.getElementById('visitConfirmBtn');
        confirmBtn.style.display = visit.status === 'pending' ? 'inline-block' : 'none';
        
        document.getElementById('visitModal').classList.add('active');
      } catch (error) {
        console.error('Failed to load visit:', error);
        alert('Failed to load visit details');
      }
    }

    function closeVisitModal() {
      document.getElementById('visitModal').classList.remove('active');
      currentVisitId = null;
    }

    async function confirmVisit() {
      if (!currentVisitId) return;
      try {
        const response = await fetch(`${API_URL}/api/scheduled-visits/${currentVisitId}/status`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ status: 'confirmed' })
        });
        
        if (response.ok) {
          closeVisitModal();
          loadContent();
        } else {
          alert('Failed to confirm visit');
        }
      } catch (error) {
        console.error('Failed to confirm visit:', error);
        alert('Failed to confirm visit');
      }
    }

    async function openCallDetail(id) {
      currentCallId = id;
      try {
        const response = await fetch(`${API_URL}/api/call-requests/${id}`, { credentials: 'include' });
        const call = await response.json();
        
        document.getElementById('callModalName').textContent = call.visitor_name;
        document.getElementById('callModalEmail').textContent = call.visitor_email || 'No email provided';
        document.getElementById('callModalPhone').textContent = call.visitor_phone;
        document.getElementById('callModalTime').textContent = new Date(call.created_at).toLocaleString();
        
        const statusBadge = document.getElementById('callModalStatus');
        statusBadge.textContent = call.status;
        statusBadge.className = `status-badge status-${call.status}`;
        
        const completeBtn = document.getElementById('callCompleteBtn');
        completeBtn.style.display = call.status === 'pending' ? 'inline-block' : 'none';
        
        document.getElementById('callModal').classList.add('active');
      } catch (error) {
        console.error('Failed to load call request:', error);
        alert('Failed to load call request details');
      }
    }

    function closeCallModal() {
      document.getElementById('callModal').classList.remove('active');
      currentCallId = null;
    }

    async function markCallComplete() {
      if (!currentCallId) return;
      try {
        const response = await fetch(`${API_URL}/api/call-requests/${currentCallId}/status`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ status: 'completed' })
        });
        
        if (response.ok) {
          closeCallModal();
          loadContent();
        } else {
          alert('Failed to mark call as complete');
        }
      } catch (error) {
        console.error('Failed to mark call complete:', error);
        alert('Failed to mark call as complete');
      }
    }

    async function assignToMe() {
      if (!currentConversationId) return;
      try {
        await fetch(`${API_URL}/api/conversations/${currentConversationId}/assign`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ userId: currentUser.id })
        });
        openConversation(currentConversationId);
      } catch (error) {
        console.error('Failed to assign:', error);
      }
    }

    async function markResolved() {
      if (!currentConversationId) return;
      try {
        await fetch(`${API_URL}/api/conversations/${currentConversationId}/status`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ status: 'resolved' })
        });
        closeModal();
      } catch (error) {
        console.error('Failed to mark resolved:', error);
      }
    }

    async function loadQuickReplies() {
      try {
        const response = await fetch(`${API_URL}/api/canned-responses`, { credentials: 'include' });
        
        if (!response.ok) {
          console.error('Failed to fetch quick replies:', response.status, response.statusText);
          return;
        }
        
        const replies = await response.json();
        console.log('Loaded quick replies:', replies);
        
        const select = document.getElementById('quickReplySelect');
        if (!select) {
          console.error('Quick reply select element not found');
          return;
        }
        
        select.innerHTML = '<option value="">üí¨ Quick Replies</option>';
        
        if (Array.isArray(replies) && replies.length > 0) {
          replies.forEach(reply => {
            const option = document.createElement('option');
            option.value = reply.message;
            option.textContent = reply.shortcut;
            select.appendChild(option);
          });
          console.log(`Loaded ${replies.length} quick replies`);
        } else {
          console.log('No quick replies found');
        }
      } catch (error) {
        console.error('Failed to load quick replies:', error);
      }
    }

    async function loadTeamMembersForReassign() {
      try {
        const response = await fetch(`${API_URL}/api/users`, { credentials: 'include' });
        const users = await response.json();
        
        const select = document.getElementById('reassignSelect');
        if (!select) return;
        
        select.innerHTML = '<option value="">Reassign to...</option>';
        
        users.forEach(user => {
          const option = document.createElement('option');
          option.value = user.id;
          option.textContent = `${user.name} (${user.role})`;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Failed to load team members:', error);
      }
    }

    async function reassignConversation() {
      const select = document.getElementById('reassignSelect');
      const userId = select.value;
      
      if (!userId || !currentConversationId) {
        select.value = '';
        return;
      }

      try {
        const response = await fetch(`${API_URL}/api/conversations/${currentConversationId}/assign`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ userId })
        });

        if (response.ok) {
          openConversation(currentConversationId);
        } else {
          alert('Failed to reassign conversation');
          select.value = '';
        }
      } catch (error) {
        console.error('Failed to reassign:', error);
        alert('Failed to reassign conversation');
        select.value = '';
      }
    }

    function insertQuickReply() {
      const select = document.getElementById('quickReplySelect');
      const input = document.getElementById('replyInput');
      
      if (select.value) {
        input.value = select.value;
        input.focus();
        select.value = '';
      }
    }

    async function sendReply() {
      const input = document.getElementById('replyInput');
      const content = input.value.trim();
      if (!content || !currentConversationId) return;

      try {
        await fetch(`${API_URL}/api/conversations/${currentConversationId}/reply`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ content })
        });
        
        await fetch(`${API_URL}/api/conversations/${currentConversationId}/assign`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ userId: currentUser.id })
        });
        
        input.value = '';
        openConversation(currentConversationId);
      } catch (error) {
        console.error('Failed to send reply:', error);
      }
    }

    async function deleteConversation(id) {
      if (!confirm('Are you sure you want to delete this conversation? This action cannot be undone.')) {
        return;
      }

      try {
        const response = await fetch(`${API_URL}/api/conversations/${id}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        if (response.ok) {
          loadContent();
        } else {
          const errorData = await response.json().catch(() => ({}));
          console.error('Delete failed:', response.status, errorData);
          alert(`Failed to delete conversation (${response.status}). Please make sure the backend is deployed with the latest changes.`);
        }
      } catch (error) {
        console.error('Failed to delete conversation:', error);
        alert('Failed to delete conversation. Please check if the backend is running.');
      }
    }

    async function deleteVisit(id) {
      if (!confirm('Are you sure you want to delete this scheduled visit? This action cannot be undone.')) {
        return;
      }

      try {
        const response = await fetch(`${API_URL}/api/scheduled-visits/${id}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        if (response.ok) {
          loadContent();
        } else {
          const errorData = await response.json().catch(() => ({}));
          console.error('Delete failed:', response.status, errorData);
          alert(`Failed to delete visit (${response.status}). Please make sure the backend is deployed with the latest changes.`);
        }
      } catch (error) {
        console.error('Failed to delete visit:', error);
        alert('Failed to delete visit. Please check if the backend is running.');
      }
    }

    async function deleteCallRequest(id) {
      if (!confirm('Are you sure you want to delete this call request? This action cannot be undone.')) {
        return;
      }

      try {
        const response = await fetch(`${API_URL}/api/call-requests/${id}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        if (response.ok) {
          loadContent();
        } else {
          const errorData = await response.json().catch(() => ({}));
          console.error('Delete failed:', response.status, errorData);
          alert(`Failed to delete call request (${response.status}). Please make sure the backend is deployed with the latest changes.`);
        }
      } catch (error) {
        console.error('Failed to delete call request:', error);
        alert('Failed to delete call request. Please check if the backend is running.');
      }
    }

    document.getElementById('teamChatInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendTeamMessage();
    });

    document.getElementById('replyInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendReply();
    });

    async function updatePresence() {
      if (currentUser) {
        try {
          await fetch(`${API_URL}/api/users/${currentUser.id}/presence`, {
            method: 'POST',
            credentials: 'include'
          });
        } catch (error) {
          // Silent fail
        }
      }
    }

    function connectDashboardWebSocket() {
      const wsUrl = API_URL.replace('https://', 'wss://').replace('http://', 'ws://');
      dashboardWs = new WebSocket(wsUrl);

      dashboardWs.onopen = () => {
        console.log('Dashboard WebSocket connected');
      };

      dashboardWs.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          console.log('Dashboard received WebSocket message:', data);
          
          if (data.type === 'visitor_typing') {
            console.log('Handling visitor typing:', data);
            handleVisitorTyping(data.conversationId, data.visitorName, data.isTyping);
          }
        } catch (error) {
          console.error('WebSocket message error:', error);
        }
      };

      dashboardWs.onerror = (error) => {
        console.error('Dashboard WebSocket error:', error);
      };

      dashboardWs.onclose = () => {
        console.log('Dashboard WebSocket closed, reconnecting...');
        setTimeout(connectDashboardWebSocket, 3000);
      };
    }

    function handleVisitorTyping(conversationId, visitorName, isTyping) {
      console.log(`handleVisitorTyping called: conversationId=${conversationId}, currentConversationId=${currentConversationId}, isTyping=${isTyping}`);
      
      // Only show typing indicator if this conversation is currently open
      if (currentConversationId !== conversationId) {
        console.log('Conversation not currently open, ignoring typing indicator');
        return;
      }

      const typingIndicator = document.getElementById('typingIndicator');
      const typingText = document.getElementById('typingText');
      
      console.log('Typing indicator element:', typingIndicator);

      if (isTyping) {
        typingText.textContent = `${visitorName} is typing...`;
        typingIndicator.style.display = 'block';
        console.log('Showing typing indicator');

        // Clear existing timeout for this conversation
        if (typingTimeouts.has(conversationId)) {
          clearTimeout(typingTimeouts.get(conversationId));
        }

        // Auto-hide after 3 seconds if no update
        const timeout = setTimeout(() => {
          typingIndicator.style.display = 'none';
          typingTimeouts.delete(conversationId);
          console.log('Auto-hiding typing indicator after timeout');
        }, 3000);

        typingTimeouts.set(conversationId, timeout);
      } else {
        typingIndicator.style.display = 'none';
        console.log('Hiding typing indicator');
        if (typingTimeouts.has(conversationId)) {
          clearTimeout(typingTimeouts.get(conversationId));
          typingTimeouts.delete(conversationId);
        }
      }
    }

    async function init() {
      const authenticated = await checkAuth();
      if (authenticated) {
        // Show AI Knowledge button for admins only
        if (currentUser && currentUser.role === 'admin') {
          document.getElementById('knowledgeBaseBtn').style.display = 'inline-block';
        }
        
        // Connect to WebSocket for realtime updates
        connectDashboardWebSocket();
        
        loadContent();
        // Wait a bit for currentUser to be set before loading team
        setTimeout(() => {
          loadTeam();
        }, 100);
        loadTeamChat();
        
        // Update every 5 seconds
        updateInterval = setInterval(() => {
          loadContent();
          loadTeam();
          loadTeamChat();
        }, 5000);
        
        // Update presence every minute
        updatePresence();
        setInterval(updatePresence, 60000);
      }
    }

    init();
  </script>
</body>
</html>
