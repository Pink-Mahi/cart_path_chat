<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Knowledge Base - Cart Path Cleaning</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f3f4f6;
      color: #111827;
      padding: 2rem;
    }

    .header {
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 {
      font-size: 1.5rem;
      color: #10b981;
    }
    .back-btn {
      background: #6b7280;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }
    .back-btn:hover {
      background: #4b5563;
    }

    .info-box {
      background: #dbeafe;
      border-left: 4px solid #3b82f6;
      padding: 1rem;
      margin-bottom: 2rem;
      border-radius: 4px;
    }
    .info-box h3 {
      color: #1e40af;
      margin-bottom: 0.5rem;
    }
    .info-box p {
      color: #1e3a8a;
      line-height: 1.6;
    }

    .actions {
      margin-bottom: 2rem;
    }
    .btn {
      background: #10b981;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
    }
    .btn:hover {
      background: #059669;
    }
    .btn-danger {
      background: #ef4444;
    }
    .btn-danger:hover {
      background: #dc2626;
    }
    .btn-secondary {
      background: #6b7280;
    }
    .btn-secondary:hover {
      background: #4b5563;
    }

    .entries-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 1.5rem;
    }
    .category-section {
      margin-bottom: 2rem;
    }
    .category-header {
      background: #f3f4f6;
      padding: 0.75rem 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      font-weight: 600;
      color: #374151;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .entry-card {
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .entry-card.inactive {
      opacity: 0.6;
      background: #f9fafb;
    }
    .entry-question {
      font-weight: 600;
      color: #111827;
      margin-bottom: 0.5rem;
    }
    .entry-answer {
      color: #4b5563;
      line-height: 1.6;
      margin-bottom: 1rem;
    }
    .entry-actions {
      display: flex;
      gap: 0.5rem;
    }
    .entry-actions button {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }
    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .status-active {
      background: #d1fae5;
      color: #065f46;
    }
    .status-inactive {
      background: #fee2e2;
      color: #991b1b;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: white;
      border-radius: 8px;
      padding: 2rem;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    .modal-header h2 {
      color: #111827;
    }
    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #6b7280;
    }
    .close-btn:hover {
      color: #111827;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: #374151;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 1rem;
    }
    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #10b981;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .checkbox-group input[type="checkbox"] {
      width: auto;
    }

    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #6b7280;
    }
    .empty-state h3 {
      margin-bottom: 0.5rem;
      color: #374151;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ü§ñ AI Knowledge Base</h1>
    <a href="/dashboard.html" class="back-btn">‚Üê Back to Dashboard</a>
  </div>

  <div class="info-box">
    <h3>üí° How It Works</h3>
    <p>
      The AI chatbot uses this knowledge base to answer customer questions. Add, edit, or organize information here, 
      and the AI will automatically use it in conversations. Keep answers concise and accurate. 
      Inactive entries won't be used by the AI but are saved for future use.
    </p>
  </div>

  <div class="actions">
    <button class="btn" onclick="openAddModal()">+ Add New Entry</button>
  </div>

  <div class="entries-container" id="entriesContainer">
    <div class="empty-state">
      <h3>Loading knowledge base...</h3>
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div class="modal" id="entryModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Add Knowledge Entry</h2>
        <button class="close-btn" onclick="closeModal()">√ó</button>
      </div>
      
      <form id="entryForm" onsubmit="saveEntry(event)">
        <div class="form-group">
          <label for="category">Category *</label>
          <select id="category" required>
            <option value="">Select a category</option>
            <option value="Services">Services</option>
            <option value="Process">Process</option>
            <option value="Benefits">Benefits</option>
            <option value="Pricing">Pricing</option>
            <option value="Coverage">Coverage</option>
            <option value="Scheduling">Scheduling</option>
            <option value="Equipment">Equipment</option>
            <option value="Environmental">Environmental</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <div class="form-group">
          <label for="question">Question *</label>
          <input type="text" id="question" placeholder="What question does this answer?" required>
        </div>

        <div class="form-group">
          <label for="answer">Answer *</label>
          <textarea id="answer" placeholder="Provide a clear, concise answer..." required></textarea>
        </div>

        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="isActive" checked>
            <label for="isActive">Active (AI will use this entry)</label>
          </div>
        </div>

        <div style="display: flex; gap: 1rem;">
          <button type="submit" class="btn">Save Entry</button>
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_URL = window.location.origin;
    let currentEditId = null;
    let allEntries = [];

    async function loadEntries() {
      try {
        const response = await fetch(`${API_URL}/api/knowledge-base`, {
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error('Failed to load entries');
        }

        allEntries = await response.json();
        renderEntries();
      } catch (error) {
        console.error('Load entries error:', error);
        document.getElementById('entriesContainer').innerHTML = `
          <div class="empty-state">
            <h3>Failed to load knowledge base</h3>
            <p style="color: #ef4444;">${error.message}</p>
          </div>
        `;
      }
    }

    function renderEntries() {
      const container = document.getElementById('entriesContainer');

      if (allEntries.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <h3>No entries yet</h3>
            <p>Add your first knowledge base entry to help the AI answer customer questions.</p>
          </div>
        `;
        return;
      }

      // Group by category
      const grouped = allEntries.reduce((acc, entry) => {
        if (!acc[entry.category]) {
          acc[entry.category] = [];
        }
        acc[entry.category].push(entry);
        return acc;
      }, {});

      let html = '';
      for (const [category, entries] of Object.entries(grouped)) {
        const activeCount = entries.filter(e => e.is_active).length;
        html += `
          <div class="category-section">
            <div class="category-header">
              <span>${category}</span>
              <span style="color: #6b7280; font-size: 0.875rem;">${activeCount} active, ${entries.length} total</span>
            </div>
        `;

        entries.forEach(entry => {
          html += `
            <div class="entry-card ${entry.is_active ? '' : 'inactive'}">
              <div class="entry-question">
                Q: ${escapeHtml(entry.question)}
                <span class="status-badge ${entry.is_active ? 'status-active' : 'status-inactive'}">
                  ${entry.is_active ? 'Active' : 'Inactive'}
                </span>
              </div>
              <div class="entry-answer">A: ${escapeHtml(entry.answer)}</div>
              <div class="entry-actions">
                <button class="btn btn-secondary" onclick="editEntry('${entry.id}')">Edit</button>
                <button class="btn btn-danger" onclick="deleteEntry('${entry.id}')">Delete</button>
              </div>
            </div>
          `;
        });

        html += '</div>';
      }

      container.innerHTML = html;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function openAddModal() {
      currentEditId = null;
      document.getElementById('modalTitle').textContent = 'Add Knowledge Entry';
      document.getElementById('entryForm').reset();
      document.getElementById('isActive').checked = true;
      document.getElementById('entryModal').classList.add('active');
    }

    function editEntry(id) {
      const entry = allEntries.find(e => e.id === id);
      if (!entry) return;

      currentEditId = id;
      document.getElementById('modalTitle').textContent = 'Edit Knowledge Entry';
      document.getElementById('category').value = entry.category;
      document.getElementById('question').value = entry.question;
      document.getElementById('answer').value = entry.answer;
      document.getElementById('isActive').checked = entry.is_active;
      document.getElementById('entryModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('entryModal').classList.remove('active');
      currentEditId = null;
    }

    async function saveEntry(event) {
      event.preventDefault();

      const data = {
        category: document.getElementById('category').value,
        question: document.getElementById('question').value,
        answer: document.getElementById('answer').value,
        isActive: document.getElementById('isActive').checked
      };

      try {
        const url = currentEditId 
          ? `${API_URL}/api/knowledge-base/${currentEditId}`
          : `${API_URL}/api/knowledge-base`;
        
        const method = currentEditId ? 'PATCH' : 'POST';

        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to save entry');
        }

        closeModal();
        await loadEntries();
      } catch (error) {
        console.error('Save entry error:', error);
        alert('Failed to save entry: ' + error.message);
      }
    }

    async function deleteEntry(id) {
      if (!confirm('Are you sure you want to delete this entry? This cannot be undone.')) {
        return;
      }

      try {
        const response = await fetch(`${API_URL}/api/knowledge-base/${id}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error('Failed to delete entry');
        }

        await loadEntries();
      } catch (error) {
        console.error('Delete entry error:', error);
        alert('Failed to delete entry: ' + error.message);
      }
    }

    // Load entries on page load
    loadEntries();
  </script>
</body>
</html>
